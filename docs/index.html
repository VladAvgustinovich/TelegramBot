<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 16px; background: var(--tg-theme-bg-color, #ffffff); color: var(--tg-theme-text-color, #111); }
      .card { background: var(--tg-theme-secondary-bg-color, #f5f5f5); padding: 16px; border-radius: 12px; }
      input, textarea { width: 100%; box-sizing: border-box; padding: 10px; border-radius: 8px; border: 1px solid #ccc; }
      button { padding: 10px 14px; border-radius: 8px; border: none; background: #2ea44f; color: #fff; cursor: pointer; }
      button:disabled { opacity: 0.6; cursor: not-allowed; }
    </style>
  </head>
  <body>
    <div class="card">
      <h3>Explain</h3>
      <p>Страница открыта из бота по кнопке «Объяснить». Ниже исходный и исправленный тексты. Нажимайте на слова для быстрого перевода.</p>
      <textarea id="text" rows="4" placeholder="Введите текст..."></textarea>
      <div style="margin-top: 8px; display: flex; gap: 8px;">
        <button id="send">Отправить в бота</button>
        <button id="close">Закрыть</button>
      </div>
      <p id="status" style="margin-top: 8px; font-size: 14px;"></p>
      <div id="tokens" style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 6px;"></div>
      <div id="details" class="card" style="margin-top:12px; display:none;"></div>
    </div>

    <script>
      const tg = window.Telegram?.WebApp;
      if (tg) {
        tg.ready();
        tg.expand();
      }

      const statusEl = document.getElementById('status');
      const textEl = document.getElementById('text');

      function detectLang(s){
        const hasRu = /[А-Яа-яЁё]/.test(s);
        const hasEn = /[A-Za-z]/.test(s);
        if (hasRu && !hasEn) return 'ru';
        if (hasEn && !hasRu) return 'en';
        return 'auto';
      }

      async function translateQuick(word){
        const lang = detectLang(word);
        let from='en', to='ru';
        if (lang==='ru') { from='ru'; to='en'; }
        const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(word)}&langpair=${from}|${to}`;
        try {
          const r = await fetch(url);
          const j = await r.json();
          return j?.responseData?.translatedText || '';
        } catch { return ''; }
      }

      function showDetails(html){
        const box = document.getElementById('details');
        box.style.display = 'block';
        box.innerHTML = html;
      }

      function renderTokens(text) {
        const container = document.getElementById('tokens');
        container.innerHTML = '';
        const parts = (text || '').split(/(\s+)/);
        parts.forEach(p => {
          if (!p.trim()) { container.appendChild(document.createTextNode(p)); return; }
          const span = document.createElement('span');
          span.textContent = p;
          span.style.padding = '2px 6px';
          span.style.borderRadius = '6px';
          span.style.border = '1px solid #ccc';
          span.style.cursor = 'pointer';
          span.onclick = async () => {
            statusEl.textContent = `Перевод: ${p} ...`;
            const tr = await translateQuick(p);
            statusEl.textContent = '';
            const safe = (x)=>x.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
            showDetails(`<div><b>${safe(p)}</b><br/>${safe(tr || 'Перевод не найден')}</div>`);
          };
          container.appendChild(span);
        });
      }

      document.getElementById('send').onclick = () => {
        const text = (textEl.value || '').trim();
        if (!text) { statusEl.textContent = 'Введите текст'; return; }
        try {
          tg?.sendData(JSON.stringify({ type: 'text', text }));
          statusEl.textContent = 'Отправлено в бота.';
          renderTokens(text);
        } catch (e) {
          statusEl.textContent = 'Не удалось отправить: ' + e;
        }
      };

      textEl.addEventListener('input', () => renderTokens(textEl.value));
      // Prefill from query params if present (src/res)
      try {
        const url = new URL(location.href);
        const src = url.searchParams.get('src') || '';
        const res = url.searchParams.get('res') || '';
        const initial = [
          src ? `Оригинал: ${src}` : '',
          res ? `Исправленный: ${res}` : '',
        ].filter(Boolean).join('\n');
        if (initial) {
          textEl.value = initial;
          renderTokens(initial);
        } else {
          renderTokens('Tap any word to look it up');
        }
      } catch {
        renderTokens('Tap any word to look it up');
      }

      document.getElementById('close').onclick = () => tg?.close();
    </script>
  </body>
  </html>



